<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Food</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body class="bg-light">
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- Sidebar trái -->
        <th:block th:replace="~{client/layout/sidebar-left :: sidebarLeft}"></th:block>
        <!-- Nội dung chính -->
        <div class="col-md-7 offset-md-2 bg-white p-4">
            <!-- Header -->
            <div class="row mb-4 align-items-center">
                <div class="col-md-6">
                    <h2 class="fw-bold">Tạo món ăn của bạn</h2>
                </div>
                <div class="col-md-6 text-end">
                    <a href="javascript:history.back()" class="btn rounded-pill px-4 me-2" style="background-color: #D9F99D;">Trở lại</a>
                    <button type="submit" form="recipeForm" class="btn rounded-pill px-4 me-2" style="background-color: #D9F99D;">Lưu và đóng</button>
                    <button class="btn rounded-pill px-4" style="background-color: #D9F99D;">Đăng lên</button>
                </div>
            </div>

            <!-- Main Content -->
            <form id="recipeForm" th:action="@{/recipes}" method="post" enctype="multipart/form-data">
                <div class="row">
                    <!-- Left Column - Food Image -->
                    <div class="col-md-5 mb-4">
                        <div id="imageSelector" class="bg-warning bg-opacity-25 rounded p-2 text-center position-relative" style="height: 280px; cursor: pointer;">
                            <img id="previewImage" th:src="${recipe.imageUrl} ?: '/images/placeholder.png'" alt="Food Image" class="img-fluid h-100 w-100 object-fit-cover rounded d-none" style="object-fit: cover;">
                            <div id="placeholderText" class="position-absolute top-50 start-50 translate-middle text-muted">
                                <p class="mb-0">Chọn ảnh<br>món ăn</p>
                            </div>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" class="d-none" name="imageFile">
                        <input type="hidden" name="imageUrl" th:value="${recipe.imageUrl}">
                    </div>

                    <!-- Right Column - Form Fields -->
                    <div class="col-md-7 mb-4">
                        <div class="mb-3">
                            <input type="text" class="form-control bg-warning bg-opacity-25 border-0 py-3" placeholder="Nhập tên món ăn" name="title" th:value="${recipe.title}" required>
                            <div class="invalid-feedback">Vui lòng nhập tên món ăn</div>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control bg-warning bg-opacity-25 border-0 py-3" rows="4" placeholder="Hãy chia sẻ ý tưởng tạo ra món ăn này" name="description" th:text="${recipe.description}"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-4 mb-3 position-relative">
                                <select class="form-control bg-warning bg-opacity-25 border-0 py-2 pe-4" name="difficulty">
                                    <option value="">Độ khó</option>
                                    <option value="Dễ" th:selected="${recipe.difficulty == 'Dễ'}">Dễ</option>
                                    <option value="Trung bình" th:selected="${recipe.difficulty == 'Trung bình'}">Trung bình</option>
                                    <option value="Khó" th:selected="${recipe.difficulty == 'Khó'}">Khó</option>
                                </select>
                                <i class="fas fa-angle-down position-absolute end-0 top-50 translate-middle-y me-4 text-muted pointer-events-none"></i>
                            </div>
                            <div class="col-4 mb-3 position-relative">
                                <select class="form-control bg-warning bg-opacity-25 border-0 py-2 pe-4" name="mealType">
                                    <option value="">Bữa ăn</option>
                                    <option value="Bữa sáng" th:selected="${recipe.mealType == 'Bữa sáng'}">Bữa sáng</option>
                                    <option value="Bữa trưa" th:selected="${recipe.mealType == 'Bữa trưa'}">Bữa trưa</option>
                                    <option value="Bữa tối" th:selected="${recipe.mealType == 'Bữa tối'}">Bữa tối</option>
                                </select>
                                <i class="fas fa-angle-down position-absolute end-0 top-50 translate-middle-y me-4 text-muted pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingredients Section -->
                <div class="row mb-4">
                    <div class="col-md-5">
                        <h4 class="mb-4">Nguyên liệu</h4>
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-2">Khẩu Phần</div>
                            <div class="flex-grow-1">
                                <input type="number" class="form-control bg-warning bg-opacity-25 border-0 w-100" placeholder="Nhập số người" th:field="*{recipe.servingSize}" required>
                                <div class="invalid-feedback" th:errors="*{recipe.servingSize}"></div>
                            </div>
                        </div>
                        <div id="selectedIngredients" class="mt-4">
                            <!-- Existing ingredients -->
                            <th:block th:each="RecipeIngredient, iterStat : ${recipe.getRecipeIngredients}">
                                <div class="d-flex align-items-center mb-3 ingredient-item">
                                    <div class="me-3"><i class="fas fa-bars"></i></div>
                                    <div class="flex-grow-1">
                                        <input type="text" class="form-control bg-warning bg-opacity-25 border-0 mb-2" name="name" th:value="${RecipeIngredient.ingredient.name}" placeholder="Tên nguyên liệu" required>                                        <input type="hidden" name="ingredientId" th:value="${ingredient.id}">
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" step="0.1" class="form-control bg-warning bg-opacity-25 border-0 mb-2" name="ingredientQuantities" th:value="${RecipeIngredient.quantity}" placeholder="Số lượng" required>
                                            </div>
                                            <div class="col-6 position-relative">
                                                <select class="form-control bg-warning bg-opacity-25 border-0 mb-2 pe-4" name="ingredientUnits" required>
                                                    <option value="" th:text="'Chọn đơn vị'" th:selected="${RecipeIngredient.unit == null}"></option>
                                                    <option value="GRAM" th:selected="${RecipeIngredient.unit == 'GRAM'}">Gram</option>
                                                    <option value="ML" th:selected="${RecipeIngredient.unit == 'ML'}">ml</option>
                                                    <option value="PIECE" th:selected="${RecipeIngredient.unit == 'PIECE'}">Cái</option>
                                                    <option value="TABLESPOON" th:selected="${RecipeIngredient.unit == 'TABLESPOON'}">Thìa canh</option>
                                                    <option value="TEASPOON" th:selected="${RecipeIngredient.unit == 'TEASPOON'}">Thìa cà phê</option>
                                                </select>
                                                <i class="fas fa-angle-down position-absolute end-0 top-50 translate-middle-y me-4 text-muted pointer-events-none"></i>
                                            </div>
                                        </div>
                                        <div class="invalid-feedback">Vui lòng nhập đầy đủ thông tin nguyên liệu</div>
                                    </div>
                                    <div class="ms-2">
                                        <button type="button" class="btn btn-link text-danger remove-ingredient" tabindex="-1">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <div class="d-flex align-items-center position-relative">
                            <div class="me-3">
                                <button type="button" class="btn btn-light rounded-circle border" id="toggleIngredientSearch">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div>Thêm nguyên liệu</div>
                            <div id="ingredientSearchContainer" class="d-none position-absolute bg-white border rounded shadow-sm mt-2" style="width: 200px; z-index: 1000; top: 100%;">
                                <input type="text" id="ingredientSearch" class="form-control border-0 p-2" placeholder="Tìm nguyên liệu...">
                                <div id="ingredientList" class="list-group" style="max-height: 150px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Steps Section -->
                    <div class="col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Các bước</h4>
                            <input type="number" class="form-control bg-warning bg-opacity-25 border-0 w-50" placeholder="Nhập thời gian nấu phút" name="cookingTime" th:value="${recipe.cookingTime}" required>
                            <div class="invalid-feedback">Vui lòng nhập thời gian nấu</div>
                        </div>
                        <div id="stepsContainer">
                            <!-- Existing instructions -->
                            <th:block th:each="instruction, iterStat : ${recipe.instructions}">
                                <div class="mb-4 step-item">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center me-2 step-number" style="width: 30px; height: 30px;" th:text="${iterStat.count}"></div>
                                        <div class="flex-grow-1">
                                            <textarea class="form-control bg-warning bg-opacity-25 border-0 rounded p-2" placeholder="Nhập mô tả bước làm..." name="instructionDescriptions" th:text="${instruction.description}" required></textarea>
                                            <div class="invalid-feedback">Vui lòng nhập mô tả bước</div>
                                            <input type="hidden" name="step" th:value="${iterStat.count}">
                                        </div>
                                        <div class="ms-2">
                                            <button type="button" class="btn btn-link text-danger remove-step" tabindex="-1">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="ms-5 mb-3 position-relative">
                                        <div class="image-select-box bg-warning bg-opacity-25 border-0 rounded text-center" style="height: 200px; cursor: pointer; width: 510px">
                                            <img th:src="${instruction.imageUrl} ?: '/images/placeholder.png'" alt="Ảnh bước làm" class="img-fluid h-100 w-100 object-fit-cover rounded border border-gray" th:classappend="${instruction.imageUrl == null} ? 'd-none' : ''" style="object-fit: cover;">
                                            <div class="position-absolute top-50 start-50 translate-middle text-muted" th:classappend="${instruction.imageUrl != null} ? 'd-none' : ''">Thêm ảnh</div>
                                        </div>
                                        <input type="file" accept="image/*" class="d-none" name="image" />
                                        <input type="hidden" name="imageUrl" th:value="${instruction.imageUrl}">
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <div class="mb-4 d-flex align-items-center">
                            <div class="me-3">
                                <button id="addStepBtn" class="btn btn-light rounded-circle border" type="button">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div>Thêm bước làm</div>
                        </div>
                    </div>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" name="createdDate" th:value="${recipe.createdDate}" th:if="${recipe.createdDate != null}">
                <input type="hidden" name="updatedDate" th:value="${recipe.updatedDate}">
            </form>
        </div>
        <!-- Sidebar phải -->
        <th:block th:replace="~{client/layout/sidebar-right :: sidebarRight}"></th:block>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chọn ảnh món ăn -->
<script>
    const imageSelector = document.getElementById("imageSelector");
    const imageInput = document.getElementById("imageInput");
    const previewImage = document.getElementById("previewImage");
    const placeholderText = document.getElementById("placeholderText");

    imageSelector.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.classList.remove("d-none");
                placeholderText.classList.add("d-none");
            };
            reader.readAsDataURL(file);
        }
    });

    if (previewImage.getAttribute('src') && previewImage.getAttribute('src') !== '/images/placeholder.png') {
        previewImage.classList.remove("d-none");
        placeholderText.classList.add("d-none");
    }
</script>

<!-- Quản lý bước làm -->
<script>
    let stepCount = document.querySelectorAll("#stepsContainer .step-item").length;

    function updateStepNumbers() {
        document.querySelectorAll("#stepsContainer .step-item").forEach((item, index) => {
            const stepNumber = item.querySelector(".step-number");
            const stepInput = item.querySelector("input[name='step']");
            stepNumber.textContent = index + 1;
            stepInput.value = index + 1;
        });
    }

    document.getElementById("addStepBtn").addEventListener("click", function() {
        stepCount++;
        const stepElement = document.createElement("div");
        stepElement.classList.add("mb-4", "step-item");
        stepElement.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <div class="bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center me-2 step-number" style="width: 30px; height: 30px;">${stepCount}</div>
                <div class="flex-grow-1">
                    <textarea class="form-control bg-warning bg-opacity-25 border-0 rounded p-2" placeholder="Nhập mô tả bước làm..." name="instructionDescriptions" required></textarea>
                    <div class="invalid-feedback">Vui lòng nhập mô tả bước</div>
                    <input type="hidden" name="step" value="${stepCount}">
                </div>
                <div class="ms-2">
                    <button type="button" class="btn btn-link text-danger remove-step" tabindex="-1">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="ms-5 mb-3 position-relative">
                <div class="image-select-box bg-warning bg-opacity-25 border-0 rounded text-center" style="height: 200px; cursor: pointer; width: 510px">
                    <img src="/images/placeholder.png" alt="Ảnh bước làm" class="img-fluid h-100 w-100 object-fit-cover rounded border border-gray d-none" style="object-fit: cover;">
                    <div class="position-absolute top-50 start-50 translate-middle text-muted">Thêm ảnh</div>
                </div>
                <input type="file" accept="image/*" class="d-none" name="image">
                <input type="hidden" name="imageUrl" value="">
            </div>
        `;
        document.getElementById("stepsContainer").appendChild(stepElement);

        const imageBox = stepElement.querySelector(".image-select-box");
        const imageInput = stepElement.querySelector("input[type='file']");
        const previewImg = stepElement.querySelector("img");
        const placeholder = stepElement.querySelector(".position-absolute");

        imageBox.addEventListener("click", () => imageInput.click());
        imageInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove("d-none");
                    placeholder.classList.add("d-none");
                };
                reader.readAsDataURL(file);
            }
        });

        updateStepNumbers();
    });

    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-step')) {
            const stepItem = e.target.closest('.step-item');
            stepItem.remove();
            stepCount--;
            updateStepNumbers();
        }
    });

    document.querySelectorAll(".image-select-box").forEach(box => {
        const fileInput = box.nextElementSibling;
        const previewImg = box.querySelector("img");
        const placeholder = box.querySelector(".position-absolute");

        box.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove("d-none");
                    placeholder.classList.add("d-none");
                };
                reader.readAsDataURL(file);
            }
        });
    });
</script>

<!-- Quản lý nguyên liệu -->
<script>
    const ingredientSearch = document.getElementById('ingredientSearch');
    const ingredientList = document.getElementById('ingredientList');
    const selectedIngredients = document.getElementById('selectedIngredients');
    const ingredientSearchContainer = document.getElementById('ingredientSearchContainer');
    const toggleIngredientSearch = document.getElementById('toggleIngredientSearch');

    let ingredientCount = document.querySelectorAll("#selectedIngredients .ingredient-item").length;

    toggleIngredientSearch.addEventListener('click', () => {
        ingredientSearchContainer.classList.toggle('d-none');
        if (!ingredientSearchContainer.classList.contains('d-none')) {
            ingredientSearch.focus();
            showIngredientList('');
        }
    });

    ingredientSearch.addEventListener('input', () => {
        const keyword = ingredientSearch.value.toLowerCase();
        showIngredientList(keyword);
    });

    function showIngredientList(keyword) {
        fetch(`/api/ingredients/search?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                ingredientList.innerHTML = '';
                data.forEach(item => {
                    const el = document.createElement('button');
                    el.className = 'list-group-item list-group-item-action p-2';
                    el.style.fontSize = '14px';
                    el.textContent = item.name;
                    el.onclick = () => addIngredient(item);
                    ingredientList.appendChild(el);
                });
            })
            .catch(error => console.error('Error:', error));
    }

    function addIngredient(ingredient) {
        const div = document.createElement('div');
        div.className = 'd-flex align-items-center mb-3 ingredient-item';
        div.innerHTML = `
        <div class="me-3"><i class="fas fa-bars"></i></div>
        <div class="flex-grow-1">
            <input type="text" class="form-control bg-warning bg-opacity-25 border-0 mb-2" name="name" value="${ingredient.name}" placeholder="Tên nguyên liệu" required>
            <input type="hidden" name="ingredientId" value="${ingredient.id}">
            <div class="row">
                <div class="col-6">
                    <input type="number" step="0.1" class="form-control bg-warning bg-opacity-25 border-0 mb-2" name="ingredientQuantities" placeholder="Số lượng" required>
                </div>
                <div class="col-6 position-relative">
                    <select class="form-control bg-warning bg-opacity-25 border-0 mb-2 pe-4" name="ingredientUnits" required>
                        <option value="">Chọn đơn vị</option>
                        <option value="GRAM">Gram</option>
                        <option value="ML">ml</option>
                        <option value="PIECE">Cái</option>
                        <option value="TABLESPOON">Thìa canh</option>
                        <option value="TEASPOON">Thìa cà phê</option>
                    </select>
                    <i class="fas fa-angle-down position-absolute end-0 top-50 translate-middle-y me-4 text-muted pointer-events-none"></i>
                </div>
            </div>
            <div class="invalid-feedback">Vui lòng nhập đầy đủ thông tin nguyên liệu</div>
        </div>
        <div class="ms-2">
            <button type="button" class="btn btn-link text-danger remove-ingredient" tabindex="-1">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
        selectedIngredients.appendChild(div);
        ingredientCount++;
        ingredientSearch.value = '';
        ingredientList.innerHTML = '';
        ingredientSearchContainer.classList.add('d-none');
    }

    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            const ingredientItem = e.target.closest('.ingredient-item');
            ingredientItem.remove();
            ingredientCount--;
        }
    });

    document.addEventListener('click', (event) => {
        if (!ingredientSearchContainer.contains(event.target) && !toggleIngredientSearch.contains(event.target)) {
            ingredientSearchContainer.classList.add('d-none');
        }
    });

    document.getElementById('recipeForm').addEventListener('submit', function(e) {
        const ingredientItems = document.querySelectorAll("#selectedIngredients .ingredient-item");
        if (ingredientItems.length === 0) {
            alert('Vui lòng thêm ít nhất một nguyên liệu');
            e.preventDefault();
            return false;
        }
        const stepItems = document.querySelectorAll("#stepsContainer .step-item");
        if (stepItems.length === 0) {
            alert('Vui lòng thêm ít nhất một bước làm');
            e.preventDefault();
            return false;
        }
        let valid = true;
        ingredientItems.forEach(item => {
            const nameInput = item.querySelector("input[name='ingredientNames']");
            const quantityInput = item.querySelector("input[name='ingredientQuantities']");
            const unitSelect = item.querySelector("select[name='ingredientUnits']");
            if (!nameInput.value) {
                nameInput.classList.add('is-invalid');
                valid = false;
            } else {
                nameInput.classList.remove('is-invalid');
            }
            if (!quantityInput.value || quantityInput.value <= 0) {
                quantityInput.classList.add('is-invalid');
                valid = false;
            } else {
                quantityInput.classList.remove('is-invalid');
            }
            if (!unitSelect.value) {
                unitSelect.classList.add('is-invalid');
                valid = false;
            } else {
                unitSelect.classList.remove('is-invalid');
            }
        });
        stepItems.forEach(item => {
            const descInput = item.querySelector("textarea[name='instructionDescriptions']");
            if (!descInput.value) {
                descInput.classList.add('is-invalid');
                valid = false;
            } else {
                descInput.classList.remove('is-invalid');
            }
        });
        if (!valid) {
            alert('Vui lòng điền đầy đủ các trường bắt buộc');
            e.preventDefault();
            return false;
        }
    });
</script>
</body>
</html>